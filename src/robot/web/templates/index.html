<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Control Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <h1>Robot Control Panel</h1>

    <div class="container">
        <!-- Control Panel -->
        <div class="panel">
            <h2>Control Panel</h2>
            <div class="button-group">
                <button id="initBtn" class="btn btn-primary">Initialize Robot</button>
                <button id="standBtn" class="btn btn-primary" disabled>Stand Up</button>
                <button id="walkBtn" class="btn btn-primary" disabled>Walk</button>
                <button id="danceBtn" class="btn btn-primary" disabled>Dance</button>
                <button id="shutdownBtn" class="btn btn-danger" disabled>Shutdown</button>
            </div>
            <div id="status" class="status"></div>
        </div>

        <!-- Servo Control Panel -->
        <div class="panel">
            <h2>Servo Control</h2>
            <div class="servo-controls">
                {% for servo in servos %}
                <div class="servo-card">
                    <h3>{{ servo.name }}</h3>
                    <div class="slider-container">
                        <input type="range" class="servo-slider" id="{{ servo.id }}" min="{{ servo.min }}"
                            max="{{ servo.max }}" value="{{ servo.default }}" disabled>
                        <span class="servo-value">{{ servo.default }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        // Servo configuration
        const servos = [
            {% for servo in servos %}
        {
            id: "{{ servo.id }}",
                name: "{{ servo.name }}",
                    min: { { servo.min } },
            max: { { servo.max } },
                default: { { servo.default } }
        } {% if not loop.last %}, {% endif %}
        {% endfor %}
        ];

        // API endpoints
        const API = {
            init: '/api/init',
            shutdown: '/api/shutdown',
            stand: '/api/stand',
            walk: '/api/walk',
            dance: '/api/dance',
            setServo: '/api/servo',
            getServos: '/api/servos'
        };

        // Helper functions
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function updateRobotState(initialized) {
            const state = document.getElementById('robotState');
            state.className = `robot-state ${initialized ? 'state-initialized' : 'state-not-initialized'}`;
            state.textContent = initialized ? 'Initialized' : 'Not Initialized';

            // Enable/disable buttons based on initialization state
            document.getElementById('standBtn').disabled = !initialized;
            document.getElementById('walkBtn').disabled = !initialized;
            document.getElementById('danceBtn').disabled = !initialized;
            document.getElementById('shutdownBtn').disabled = !initialized;

            // Enable/disable servo sliders
            document.querySelectorAll('.servo-slider').forEach(slider => {
                slider.disabled = !initialized;
            });
        }

        // Event listeners
        document.getElementById('initBtn').addEventListener('click', async () => {
            try {
                const response = await fetch(API.init, { method: 'POST' });
                const data = await response.json();
                if (data.status === 'success') {
                    showStatus(data.message || 'Robot initialized successfully', 'success');
                    updateRobotState(true);
                } else {
                    showStatus(data.message || 'Failed to initialize robot', 'error');
                }
            } catch (error) {
                showStatus('Error initializing robot: ' + error.message, 'error');
            }
        });

        document.getElementById('shutdownBtn').addEventListener('click', async () => {
            try {
                const response = await fetch(API.shutdown, { method: 'POST' });
                const data = await response.json();
                if (data.status === 'success') {
                    showStatus(data.message || 'Robot shut down successfully', 'success');
                    updateRobotState(false);
                } else {
                    showStatus(data.message || 'Failed to shut down robot', 'error');
                }
            } catch (error) {
                showStatus('Error shutting down robot: ' + error.message, 'error');
            }
        });

        document.getElementById('standBtn').addEventListener('click', async () => {
            try {
                const response = await fetch(API.stand, { method: 'POST' });
                const data = await response.json();
                if (data.status === 'success') {
                    showStatus(data.message || 'Robot standing up', 'success');
                } else {
                    showStatus(data.message || 'Failed to make robot stand', 'error');
                }
            } catch (error) {
                showStatus('Error making robot stand: ' + error.message, 'error');
            }
        });

        document.getElementById('walkBtn').addEventListener('click', async () => {
            try {
                const response = await fetch(API.walk, { method: 'POST' });
                const data = await response.json();
                if (data.status === 'success') {
                    showStatus(data.message || 'Robot walking', 'success');
                } else {
                    showStatus(data.message || 'Failed to make robot walk', 'error');
                }
            } catch (error) {
                showStatus('Error making robot walk: ' + error.message, 'error');
            }
        });

        document.getElementById('danceBtn').addEventListener('click', async () => {
            try {
                const response = await fetch(API.dance, { method: 'POST' });
                const data = await response.json();
                if (data.status === 'success') {
                    showStatus(data.message || 'Robot dancing', 'success');
                } else {
                    showStatus(data.message || 'Failed to make robot dance', 'error');
                }
            } catch (error) {
                showStatus('Error making robot dance: ' + error.message, 'error');
            }
        });

        // Servo slider event listeners
        servos.forEach(servo => {
            const slider = document.getElementById(servo.id);
            const valueDisplay = slider.nextElementSibling;

            slider.addEventListener('input', () => {
                valueDisplay.textContent = slider.value;
            });

            slider.addEventListener('change', async () => {
                try {
                    const response = await fetch(API.setServo, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            servo: servo.id,
                            position: parseInt(slider.value)
                        })
                    });
                    const data = await response.json();
                    if (data.status !== 'success') {
                        showStatus(data.message || 'Failed to set servo position', 'error');
                    }
                } catch (error) {
                    showStatus('Error setting servo position: ' + error.message, 'error');
                }
            });
        });

        // Periodically update servo positions and sensor data
        setInterval(async () => {
            try {
                // Update servo positions
                const servosResponse = await fetch(API.getServos);
                const servosData = await servosResponse.json();
                if (servosData.status === 'success') {
                    servosData.servos.forEach(servo => {
                        const slider = document.getElementById(servo.id);
                        if (slider) {
                            slider.value = servo.position;
                            slider.nextElementSibling.textContent = servo.position;
                        }
                    });
                }
            } catch (error) {
                console.error('Error updating data:', error);
            }
        }, 1000);
    </script>
</body>

</html>